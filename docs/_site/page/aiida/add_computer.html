<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>外部コードを実行する | personal website</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="外部コードを実行する" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<link rel="canonical" href="http://localhost:4000/page/aiida/add_computer.html" />
<meta property="og:url" content="http://localhost:4000/page/aiida/add_computer.html" />
<meta property="og:site_name" content="personal website" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="外部コードを実行する" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"外部コードを実行する","url":"http://localhost:4000/page/aiida/add_computer.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=c90158fd34f66e4f63b4da45038b5d6170d798eb">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    

<!--  -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="http://localhost:4000/">personal website</a></h1>

        

        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>

        
        <p class="view"><a href="https://github.com/dirac6582/dirac6582.github.io.git">View the Project on GitHub <small>dirac6582/dirac6582.github.io.git</small></a></p>
        

        

        
      </header>
      <section>

      
<h1 id="外部コードを実行する">外部コードを実行する</h1>

<p>外部コードを利用する場合，<code class="language-plaintext highlighter-rouge">computer</code>と<code class="language-plaintext highlighter-rouge">code</code>という概念を理解する必要がある．<code class="language-plaintext highlighter-rouge">computer</code>は計算を実行するマシンのことであり，AiiDAのインストールされているマシン(localhost)のみならず，ssh接続できる他のマシンも指定できる．なので自分のデスクトップにAiiDAをインストールしてデータの解析はここで行い，実際の重い計算はスーパーコンピュータシステムで行うようなことが可能である．一方<code class="language-plaintext highlighter-rouge">code</code>はコンピュータ上で実際に実行するコードのことであり，例えばQuantum Espresso(QE)のようなパッケージのほか，自作のコードも指定できる．<code class="language-plaintext highlighter-rouge">code</code>は<code class="language-plaintext highlighter-rouge">computer</code>ごとに指定する必要があり，例えばQEを自分のパソコンでもスーパーコンピュータでも実行したい場合，QE@localhostとQE@supercomputerのようにそれぞれのコンピュータ用に設定する必要がある．</p>

<h2 id="コンピュータの追加リモートマシンで実行する場合1">コンピュータの追加:リモートマシンで実行する場合1</h2>

<p>ローカル以外のコンピューターでも利用したい場合には<code class="language-plaintext highlighter-rouge">verdi computer</code>コマンドでコンピュータを追加する必要がある．試しにローカルマシンをコンピュータとして追加してみよう．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># コンピュータのセットアップ</span>
<span class="nv">$ </span>verdi computer setup <span class="nt">-L</span> tutor <span class="nt">-H</span> localhost <span class="nt">-T</span> core.local <span class="nt">-S</span> core.direct <span class="nt">-w</span> <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$PWD</span>/work<span class="sb">`</span> <span class="nt">-n</span>
<span class="c"># セットアップしたコンピュータを利用可能なように設定</span>
<span class="nv">$ </span>verdi computer configure core.local tutor <span class="nt">--safe-interval</span> 1 <span class="nt">-n</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># setup
</span><span class="o">%</span><span class="n">verdi</span> <span class="n">computer</span> <span class="n">setup</span> <span class="o">-</span><span class="n">L</span> <span class="n">tutor</span> <span class="o">-</span><span class="n">H</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">T</span> <span class="n">core</span><span class="p">.</span><span class="n">local</span> <span class="o">-</span><span class="n">S</span> <span class="n">core</span><span class="p">.</span><span class="n">direct</span> <span class="o">-</span><span class="n">w</span> <span class="p">{</span><span class="n">profile</span><span class="p">.</span><span class="n">repository_path</span> <span class="o">/</span> <span class="s">'work'</span><span class="p">}</span> <span class="o">-</span><span class="n">n</span>

<span class="c1"># 登録してこのコンピュータに計算を投げられるようにする．
</span><span class="o">%</span><span class="n">verdi</span> <span class="n">computer</span> <span class="n">configure</span> <span class="n">core</span><span class="p">.</span><span class="n">local</span> <span class="n">tutor</span> <span class="o">--</span><span class="n">safe</span><span class="o">-</span><span class="n">interval</span> <span class="mi">0</span> <span class="o">-</span><span class="n">n</span>
</code></pre></div></div>

<p>各種のオプションは以下</p>

<ul>
  <li>label (-L): tutor (わかりやすいようなラベル)</li>
  <li>hostname (-H): localhost (ローカルマシンの場合はこれで良い．リモートの場合はssh接続先のhostname)</li>
  <li>transport (-T): local</li>
  <li>scheduler (-S): direct (job schedullerなしの場合)</li>
  <li>work-dir (-w): The work subdirectory of the current directory</li>
  <li>n: non-interactive （追加の設定なしで済ませるため）</li>
</ul>

<p>登録が完了したかどうかのチェックも<code class="language-plaintext highlighter-rouge">verdi computer</code>コマンドで可能だ．また，実際にこのコンピュータ用のワーキングディレクトリが作成されていることも確認しよう．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># configureしたコンピュータの一覧表示</span>
<span class="nv">$ </span>verdi computer list
Report: List of configured computers
<span class="k">*</span> tutor

<span class="c"># 特定のコンピュータの細かい設定表示</span>
<span class="nv">$ </span>verdi computer show tutor
<span class="nt">---------------------------</span>  <span class="nt">-----------------------------------------------</span>
Label                        tutor
PK                           1
UUID                         b13064e6-bc8b-4abf-aeed-2254f31adeb2
Description
Hostname                     localhost
Transport <span class="nb">type               </span>core.local
Scheduler <span class="nb">type               </span>core.direct
Work directory               /Users/amano/works/research/aiida_tutorial/work
Shebang                      <span class="c">#!/bin/bash</span>
Mpirun <span class="nb">command               </span>mpirun <span class="nt">-np</span> <span class="o">{</span>tot_num_mpiprocs<span class="o">}</span>
Default <span class="c">#procs/machine</span>
Default memory <span class="o">(</span>kB<span class="o">)</span>/machine
Prepend text
Append text
<span class="nt">---------------------------</span>  <span class="nt">-----------------------------------------------</span>
</code></pre></div></div>

<p>これでコードが設定できていることを<code class="language-plaintext highlighter-rouge">verdi compute list</code>コマンドで確認する．</p>

<h2 id="リモートコンピュータの追加リモートマシンで実行する場合2">リモートコンピュータの追加:リモートマシンで実行する場合2</h2>

<p>同じようにリモートコンピュータを追加してみる．今度は-Tオプションでsshを選択し，-Sでリモートマシンのジョブスケジューラを設定する．ここでは例としてslurmにしてある．-wは実際に計算を行うディレクトリで，リモートマシン上のディレクトリを指定するところなので注意．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># コンピュータのセットアップ</span>
verdi computer setup <span class="nt">-L</span> sauron <span class="nt">-H</span> sauron <span class="nt">-T</span> core.ssh <span class="nt">-S</span> core.slurm <span class="nt">-w</span> <span class="s2">"/home/.aiida_run"</span> <span class="nt">-n</span>

<span class="c"># コンピュータの登録</span>
verdi <span class="nt">-p</span> ta computer configure core.ssh sauron
Report: enter ? <span class="k">for </span>help.
Report: enter <span class="o">!</span> to ignore the default and <span class="nb">set </span>no value.
User name <span class="o">[</span>amano]: amano
Port number <span class="o">[</span>22]: 22
Look <span class="k">for </span>keys <span class="o">[</span>Y/n]: y
SSH key file <span class="o">[</span>/Users/amano/.ssh/id_sauron_imacnew]: /Users/amano/.ssh/id_rsa_sauron
Connection <span class="nb">timeout </span><span class="k">in </span>s <span class="o">[</span>60]: 180
Allow ssh agent <span class="o">[</span>Y/n]: y
SSH proxy jump <span class="o">[]</span>:
SSH proxy <span class="nb">command</span> <span class="o">[]</span>:
Compress file transfers <span class="o">[</span>Y/n]: y
GSS auth <span class="o">[</span>False]:
GSS kex <span class="o">[</span>False]:
GSS deleg_creds <span class="o">[</span>False]:
GSS host <span class="o">[</span>sauron]:
Load system host keys <span class="o">[</span>Y/n]:
Key policy <span class="o">(</span>RejectPolicy, WarningPolicy, AutoAddPolicy<span class="o">)</span> <span class="o">[</span>RejectPolicy]:
Use login shell when executing <span class="nb">command</span> <span class="o">[</span>Y/n]: y
Connection cooldown <span class="nb">time</span> <span class="o">(</span>s<span class="o">)</span> <span class="o">[</span>30.0]:
Report: Configuring computer COM <span class="k">for </span>user USER.
</code></pre></div></div>

<p>configureが終わったら<code class="language-plaintext highlighter-rouge">verdi computer test</code>コマンドでリモートマシンへの接続が成功しているかをチェックする．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>verdi computer <span class="nb">test </span>sauron      
<span class="k">*</span> Opening connection... <span class="o">[</span>OK]
<span class="k">*</span> Checking <span class="k">for </span>spurious output... <span class="o">[</span>OK]
<span class="k">*</span> Getting number of <span class="nb">jobs </span>from scheduler... <span class="o">[</span>OK]: 0 <span class="nb">jobs </span>found <span class="k">in </span>the queue
<span class="k">*</span> Determining remote user name... <span class="o">[</span>OK]: amano
<span class="k">*</span> Creating and deleting temporary file... <span class="o">[</span>OK]
Success: all 5 tests succeeded
</code></pre></div></div>

<p>これが成功していればとりあえずはリモートマシンへのssh接続，ジョブスケジューラへの接続は成功している．</p>

<h2 id="外部コードを実行する場合"><a href="https://aiida.readthedocs.io/projects/aiida-core/en/v2.0.3/howto/run_codes.html#how-to-run-codes">外部コードを実行する場合</a></h2>

<p>コンピュータの設定が完了したら，そのコンピュータ上で動かすコードを登録できる．これには<code class="language-plaintext highlighter-rouge">verdi code</code>コマンドを利用する．aiidaにプリインストールされているコードならば以下のようにすれば良い．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># tutorにcore.arithmetic.add(元々ある和を取るプログラム)を追加する例</span>
<span class="nv">$ </span>verdi code setup <span class="nt">-L</span> add <span class="nt">--on-computer</span> <span class="nt">--computer</span><span class="o">=</span>tutor <span class="nt">-P</span> core.arithmetic.add <span class="nt">--remote-abs-path</span><span class="o">=</span>/bin/bash <span class="nt">-n</span>

<span class="c"># 追加されたことを確認</span>
<span class="nv">$ </span>verdi code list
</code></pre></div></div>

<p><a href="https://aiida.readthedocs.io/projects/aiida-core/en/v2.0.3/howto/plugins_install.html#how-to-plugins-install">Quantum espressoなどの外部コードを実行する場合</a>，対応するAiiDAプラグインが必要なので，これをpipでインストールしておく．プラグインのリストは<a href="https://aiidateam.github.io/aiida-registry">ここ</a>から確認できる．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DFT計算で擬ポテンシャルを扱う場合(option)</span>
pip <span class="nb">install </span>aiida-pseudo

<span class="c"># quantum espressoを利用する場合</span>
pip <span class="nb">install </span>aiida-quantumespresso

<span class="c"># VASPを利用する場合 </span>
pip <span class="nb">install </span>aiida-vasp

<span class="c"># インストール後，daemonを再スタートする．</span>
<span class="nv">$ </span>verdi daemon restart <span class="nt">--reset</span>

<span class="c"># pluginが認識されていることを確認するには</span>
<span class="c"># まずlistでカテゴリを表示</span>
<span class="nv">$ </span>verdi plugin list

<span class="c"># ついでそのカテゴリ内のプラグインを表示(一例)</span>
<span class="nv">$ </span>verdi plugin list aiida.calculations
</code></pre></div></div>

<p>yamlファイルで登録する場合．</p>

<pre><code class="language-yaml:qe_7.0.yaml">---
label: "qe-7.0-pw"
description: "quantum_espresso v7.0 pw.x"
input_plugin: "quantumespresso.pw" #これが必要!!
on_computer: true 
remote_abs_path: "/home/amano/src/qe-7.0/bin/pw.x" # コマンドへのpath
computer: "sauron"
prepend_text: " "
append_text: " "
</code></pre>

<p>追加する際のコマンドは以下のようになる．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 追加</span>
<span class="nv">$ </span>verdi code setup <span class="nt">--config</span> qe_7.0.yaml <span class="nt">-n</span>
Success: Code&lt;3&gt; qe-7.0-pw@sauron created

<span class="c"># 追加されたことを確認</span>
<span class="nv">$ </span>verdi code list 

<span class="nv">$ </span>verdi code show qe-7.0-pw
</code></pre></div></div>

<h2 id="実際にaiidaにjobを投げる"><a href="https://aiida.readthedocs.io/projects/aiida-core/en/v2.0.3/howto/run_codes.html#how-to-run-codes">実際にAiiDAにjobを投げる</a></h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>verdi run submit.py
</code></pre></div></div>

<h2 id="実際にaiidaにjobを投げるqe"><a href="https://aiida.readthedocs.io/projects/aiida-core/en/v2.0.3/topics/processes/usage.html#topics-processes-usage-launching">実際にAiiDAにjobを投げる:QE</a></h2>

<!-- https://eminamitani.github.io/website/2021/03/25/aiida_2/ -->

<p>QEでjobを実行してみよう．QEの場合の公式tutorialは<a href="https://aiida-tutorials.readthedocs.io/en/tutorial-qe-short/">ここ</a>から確認できる．</p>

<h3 id="step1-pseudoポテンシャルのdl">step1: pseudoポテンシャルのDL</h3>

<p>QEで使えるssspライブラリをインストールする．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ライブラリのinstall</span>
<span class="nv">$ </span>aiida-pseudo <span class="nb">install </span>sssp           
Report: downloading patch versions information...  <span class="o">[</span>OK]
Report: downloading selected pseudopotentials archive...  <span class="o">[</span>OK]
Report: downloading selected pseudopotentials metadata...  <span class="o">[</span>OK]
Report: unpacking archive and parsing pseudos...  <span class="o">[</span>OK]
Success: installed <span class="sb">`</span>SSSP/1.1/PBE/efficiency<span class="sb">`</span> containing 85 pseudopotentials.

<span class="c"># 正しくインストールしていることを確認</span>
<span class="nv">$ </span>aiida-pseudo list
Label                    Type string         Count
<span class="nt">-----------------------</span>  <span class="nt">------------------</span>  <span class="nt">-------</span>
SSSP/1.1/PBE/efficiency  pseudo.family.sssp  85
</code></pre></div></div>

<h3 id="step2-計算条件-結晶構造-k点-擬ポテンシャルを指定した入力ファイルの作成">step2: 計算条件， 結晶構造, K点, 擬ポテンシャルを指定した入力ファイルの作成</h3>

<p>公式チュートリアルのようにインターラクティブにやることも可能だが，ここでは入力ファイルを作成する方法を試す．</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">The</span> <span class="n">DataFactory</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">useful</span> <span class="ow">and</span> <span class="n">robust</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">loading</span> <span class="n">data</span> <span class="n">types</span> <span class="n">based</span> <span class="n">on</span> <span class="n">their</span> <span class="n">entry</span> <span class="n">point</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="s">'array.kpoints'</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span><span class="p">.</span> 
</code></pre></div></div>

<ol>
  <li><a href="https://aiida.readthedocs.io/projects/aiida-core/en/latest/topics/calculations/usage.html">ジョブスケジューラの計算リソースなど，QE以外の設定</a>
QEのinput以外の設定は<code class="language-plaintext highlighter-rouge">metadata</code>に設定する．メタデータとは、実行されたプロセスの実績グラフに入力として表示されるノードではないという意味で、入力とは異なる．むしろこれらは、プロセスの挙動をわずかに変更したり、その実行を表すプロセスノードに属性を設定することを可能にする入力である．以下のメタデータ入力は、すべてのプロセスクラスで利用可能．特にmpi並列数などの計算リソースの設定は，<code class="language-plaintext highlighter-rouge">metadata.options</code>に設定する．</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="p">{</span><span class="s">'num_machines'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"resources"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"num_machines"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                 <span class="c1"># run on 1 node
</span>        <span class="s">"tot_num_mpiprocs"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>             <span class="c1"># use 1 process
</span>        <span class="s">"num_mpiprocs_per_machine"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">"max_wallclock_seconds"</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1h walltime
</span>    <span class="s">"max_memory_kb"</span><span class="p">:</span> <span class="mi">2000000</span><span class="p">,</span>              <span class="c1"># 2GB memory
</span>    <span class="s">"queue_name"</span><span class="p">:</span> <span class="s">"molsim"</span><span class="p">,</span>                <span class="c1"># slurm partition to use
</span>    <span class="s">"withmpi"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>                      <span class="c1"># we run in serial mode
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="計算を投げる">計算を投げる</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>verdi run tutorial.py
</code></pre></div></div>

<h3 id="計算プロセス-結果の確認">計算プロセス， 結果の確認</h3>

<p><code class="language-plaintext highlighter-rouge">verdi process</code>コマンドによって結果を確認する方法がある．</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 走っているプロセスの一覧を表示</span>
<span class="nv">$ </span>verdi process list 
  PK  Created    Process label             Process State    Process status
<span class="nt">----</span>  <span class="nt">---------</span>  <span class="nt">------------------------</span>  <span class="nt">---------------</span>  <span class="nt">----------------</span>
 125  12m ago    PwCalculation   running

<span class="c"># 特定のprocessについてのより詳しい情報を表示</span>
<span class="nv">$ </span>verdi process show 125
Property     Value
<span class="nt">-----------</span>  <span class="nt">------------------------------------</span>
<span class="nb">type         </span>PwCalculation
state        Finished <span class="o">[</span>0]
pk           125
uuid         e82e1df9-2b41-4132-85b7-806e42d90560
label
description
ctime        2022-08-14 01:06:39.927911+09:00
mtime        2022-08-14 01:13:43.289752+09:00
computer     <span class="o">[</span>3] sauron

Inputs      PK    Type
<span class="nt">----------</span>  <span class="nt">----</span>  <span class="nt">-------------</span>
pseudos
    Si      36    UpfData
code        121   Code
kpoints     123   KpointsData
parameters  124   Dict
structure   122   StructureData

Outputs              PK  Type
<span class="nt">-----------------</span>  <span class="nt">----</span>  <span class="nt">--------------</span>
output_band         128  BandsData
output_parameters   130  Dict
output_trajectory   129  TrajectoryData
remote_folder       126  RemoteData
retrieved           127  FolderData

<span class="c"># 特定のprocessについての結果をグラフ化する．</span>
<span class="nv">$ </span>verdi node graph generate 125
</code></pre></div></div>

<p>計算終了後，stateが0になっていれば計算が成功していることを意味し，失敗していればそれ以外のstateになっているので原因を確認する．結果をより詳しく見る方法をいくつかリストアップする．</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">verdi calcjob</code>コマンド</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># コードのinputを取得</span>
<span class="nv">$ </span>verdi calcjob inputcat 125
<span class="c"># コードのstdoutを取得</span>
<span class="nv">$ </span>verdi calcjob outputcat 125
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">verdi data</code>コマンド</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>verdi data core.dict show 13
</code></pre></div></div>


      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/dirac6582">dirac6582</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
